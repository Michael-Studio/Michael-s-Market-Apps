<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terraria-style: —Ä—ã–±–∞–ª–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–≤–µ—Ä–∏ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è, —Å—É–Ω–¥—É–∫–∏ —Ö—Ä–∞–Ω—è—Ç</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            cursor: crosshair;
        }
        #ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            pointer-events: none;
            z-index: 100;
            color: white;
            text-shadow: 2px 2px 0 #000;
            padding: 10px;
        }
        #hotbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
            border: 2px solid #aa8;
            pointer-events: auto;
            z-index: 200;
        }
        .slot {
            width: 70px;
            height: 70px;
            background: rgba(30,30,30,0.9);
            border: 2px solid #665;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            color: white;
            font-size: 12px;
            transition: 0.1s;
        }
        .slot.selected {
            border-color: #ffaa00;
            background: #543;
            transform: scale(1.05);
            box-shadow: 0 0 15px #ffaa00;
        }
        .slot-icon { font-size: 30px; line-height: 1; }
        .slot-count {
            position: absolute;
            bottom: 2px;
            right: 5px;
            font-size: 14px;
            font-weight: bold;
            color: #ffaa00;
        }
        #bars {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 220px;
            background: rgba(0,0,0,0.6);
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #aa8;
            pointer-events: none;
        }
        .bar {
            height: 20px;
            margin: 5px 0;
            border-radius: 10px;
            overflow: hidden;
            background: #333;
        }
        .bar-fill {
            height: 100%;
            width: 100%;
            transition: width 0.2s;
        }
        #health-fill { background: linear-gradient(90deg, #a00, #f55); }
        #hunger-fill { background: linear-gradient(90deg, #da0, #fe3); }
        #clock {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 30px;
            border: 2px solid #ffaa00;
            font-weight: bold;
            color: white;
            z-index: 300;
        }
        #craft-menu, #adv-craft-menu, #furnace-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            border: 3px solid #ffaa00;
            border-radius: 20px;
            padding: 20px;
            display: none;
            flex-wrap: wrap;
            gap: 10px;
            max-width: 600px;
            pointer-events: auto;
            z-index: 300;
            color: white;
        }
        .craft-recipe {
            width: 120px;
            background: #333;
            border: 1px solid #665;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: 0.1s;
        }
        .craft-recipe:hover {
            background: #554;
            border-color: #ffaa00;
        }
        #btn-save {
            position: fixed;
            bottom: 120px;
            left: 20px;
            background: #2a2;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            pointer-events: auto;
            z-index: 200;
        }
        #btn-load {
            position: fixed;
            bottom: 120px;
            left: 140px;
            background: #22a;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            pointer-events: auto;
            z-index: 200;
        }
        #debug {
            position: fixed;
            bottom: 200px;
            left: 20px;
            color: #0f0;
            background: #000;
            padding: 5px;
            font-size: 12px;
            pointer-events: none;
        }
        #death-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: red;
            font-size: 48px;
            font-weight: bold;
            padding: 20px;
            border-radius: 20px;
            border: 3px solid red;
            display: none;
            z-index: 400;
            pointer-events: none;
        }
        #coin-counter {
            position: fixed;
            top: 10px;
            right: 200px;
            background: gold;
            color: black;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            border: 2px solid #aa8;
            z-index: 300;
        }
    </style>
</head>
<body>
    <div id="ui">
        <div id="bars">
            <div>–ó–¥–æ—Ä–æ–≤—å–µ</div>
            <div class="bar"><div id="health-fill" class="bar-fill" style="width:100%"></div></div>
            <div>–ì–æ–ª–æ–¥</div>
            <div class="bar"><div id="hunger-fill" class="bar-fill" style="width:100%"></div></div>
        </div>
        <div id="clock">‚òÄÔ∏è –î–µ–Ω—å 1</div>
        <div id="debug"></div>
        <div id="coin-counter">ü™ô 0</div>
    </div>

    <div id="hotbar"></div>

    <button id="btn-save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button id="btn-load">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>

    <div id="craft-menu">
        <h3 style="width:100%; text-align:center;">–ë–∞–∑–æ–≤—ã–π –∫—Ä–∞—Ñ—Ç (E)</h3>
        <div class="craft-recipe" id="craft-sword">üó°Ô∏è –ú–µ—á<br><small>3 –∫–∞–º–Ω—è, 1 –¥–µ—Ä–µ–≤–æ</small></div>
        <div class="craft-recipe" id="craft-workbench">ü™ë –í–µ—Ä—Å—Ç–∞–∫<br><small>5 –¥–µ—Ä–µ–≤–∞</small></div>
        <div class="craft-recipe" id="craft-woodpickaxe">ü™ì –î–µ—Ä–µ–≤—è–Ω–Ω–∞—è –∫–∏—Ä–∫–∞<br><small>3 –¥–µ—Ä–µ–≤–∞</small></div>
        <div class="craft-recipe" id="craft-door">üö™ –î–≤–µ—Ä—å<br><small>4 –¥–µ—Ä–µ–≤–∞</small></div>
        <div class="craft-recipe" id="craft-chest">üì¶ –°—É–Ω–¥—É–∫<br><small>8 –¥–µ—Ä–µ–≤–∞</small></div>
        <div class="craft-recipe" id="craft-stonepickaxe">‚õèÔ∏è –ö–∞–º–µ–Ω–Ω–∞—è –∫–∏—Ä–∫–∞<br><small>3 –∫–∞–º–Ω—è</small></div>
        <div class="craft-recipe" id="craft-stoneaxe">ü™ì –ö–∞–º–µ–Ω–Ω—ã–π —Ç–æ–ø–æ—Ä<br><small>3 –∫–∞–º–Ω—è</small></div>
        <div class="craft-recipe" id="craft-fishingrod">üé£ –£–¥–æ—á–∫–∞<br><small>5 –¥–µ—Ä–µ–≤–∞</small></div>
        <div class="craft-recipe" id="craft-bread">üçû –•–ª–µ–±<br><small>3 –ø—à–µ–Ω–∏—Ü—ã</small></div>
        <div class="craft-recipe" id="craft-torch">üïØÔ∏è –§–∞–∫–µ–ª (3)<br><small>1 —É–≥–æ–ª—å, 1 –ø–∞–ª–∫–∞</small></div>
        <div class="craft-recipe" id="craft-copperpickaxe">‚õèÔ∏è –ú–µ–¥–Ω–∞—è –∫–∏—Ä–∫–∞<br><small>3 –º–µ–¥–∏, 2 –¥–µ—Ä–µ–≤–∞</small></div>
        <div class="craft-recipe" id="craft-coppersword">‚öîÔ∏è –ú–µ–¥–Ω—ã–π –º–µ—á<br><small>3 –º–µ–¥–∏, 1 –¥–µ—Ä–µ–≤–æ</small></div>
        <div class="craft-recipe" id="craft-boomerang">ü™É –ë—É–º–µ—Ä–∞–Ω–≥<br><small>3 –¥–µ—Ä–µ–≤–∞, 1 –∂–µ–ª–µ–∑–æ</small></div>
        <div class="craft-recipe" id="craft-bow">üèπ –õ—É–∫<br><small>3 –¥–µ—Ä–µ–≤–∞, 1 –Ω–∏—Ç—å</small></div>
        <div class="craft-recipe" id="craft-arrow">üèπ –°—Ç—Ä–µ–ª—ã (5)<br><small>1 –∫–∞–º–µ–Ω—å, 1 –¥–µ—Ä–µ–≤–æ</small></div>
        <div class="craft-recipe" id="craft-hook">ü™ù –ö—Ä—é–∫-–∫–æ—à–∫–∞<br><small>3 –∂–µ–ª–µ–∑–∞, 1 –≤–µ—Ä–µ–≤–∫–∞</small></div>
    </div>

    <div id="adv-craft-menu">
        <h3 style="width:100%; text-align:center;">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –∫—Ä–∞—Ñ—Ç (–≤–µ—Ä—Å—Ç–∞–∫)</h3>
        <div class="craft-recipe" id="craft-furnace">üî• –ü–µ—á—å<br><small>10 –∫–∞–º–Ω—è, 3 –≥–ª–∏–Ω—ã</small></div>
        <div class="craft-recipe" id="craft-iron-sword">‚öîÔ∏è –ñ–µ–ª–µ–∑–Ω—ã–π –º–µ—á<br><small>3 –∂–µ–ª–µ–∑–∞, 1 –¥–µ—Ä–µ–≤–æ</small></div>
        <div class="craft-recipe" id="craft-iron-pickaxe">‚õèÔ∏è –ñ–µ–ª–µ–∑–Ω–∞—è –∫–∏—Ä–∫–∞<br><small>3 –∂–µ–ª–µ–∑–∞, 2 –¥–µ—Ä–µ–≤–∞</small></div>
        <div class="craft-recipe" id="craft-iron-axe">ü™ì –ñ–µ–ª–µ–∑–Ω—ã–π —Ç–æ–ø–æ—Ä<br><small>3 –∂–µ–ª–µ–∑–∞, 2 –¥–µ—Ä–µ–≤–∞</small></div>
        <div class="craft-recipe" id="craft-copper-helmet">ü™ñ –ú–µ–¥–Ω—ã–π —à–ª–µ–º<br><small>5 –º–µ–¥–∏</small></div>
        <div class="craft-recipe" id="craft-copper-chest">üëï –ú–µ–¥–Ω—ã–π –Ω–∞–≥—Ä—É–¥–Ω–∏–∫<br><small>8 –º–µ–¥–∏</small></div>
        <div class="craft-recipe" id="craft-copper-leggings">üëñ –ú–µ–¥–Ω—ã–µ –ø–æ–Ω–æ–∂–∏<br><small>6 –º–µ–¥–∏</small></div>
        <div class="craft-recipe" id="craft-iron-helmet">ü™ñ –ñ–µ–ª–µ–∑–Ω—ã–π —à–ª–µ–º<br><small>5 –∂–µ–ª–µ–∑–∞</small></div>
        <div class="craft-recipe" id="craft-iron-chest">üëï –ñ–µ–ª–µ–∑–Ω—ã–π –Ω–∞–≥—Ä—É–¥–Ω–∏–∫<br><small>8 –∂–µ–ª–µ–∑–∞</small></div>
        <div class="craft-recipe" id="craft-iron-leggings">üëñ –ñ–µ–ª–µ–∑–Ω—ã–µ –ø–æ–Ω–æ–∂–∏<br><small>6 –∂–µ–ª–µ–∑–∞</small></div>
    </div>

    <div id="furnace-menu">
        <h3 style="width:100%; text-align:center;">–ü–µ—á—å (–ø–ª–∞–≤–∫–∞)</h3>
        <div class="craft-recipe" id="smelt-iron">üî© –ñ–µ–ª–µ–∑–Ω—ã–π —Å–ª–∏—Ç–æ–∫<br><small>1 –∂–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞ + 1 —É–≥–æ–ª—å</small></div>
        <div class="craft-recipe" id="smelt-copper">üî© –ú–µ–¥–Ω—ã–π —Å–ª–∏—Ç–æ–∫<br><small>1 –º–µ–¥–Ω–∞—è —Ä—É–¥–∞ + 1 —É–≥–æ–ª—å</small></div>
    </div>

    <div id="death-message">üíÄ –í–´ –£–ú–ï–†–õ–ò üíÄ</div>

    <script>
        // ---------- –ù–ê–°–¢–†–û–ô–ö–ò ----------
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        document.body.appendChild(canvas);
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        const BLOCK_SIZE = 40;
        const WORLD_WIDTH = 200;
        const WORLD_HEIGHT = 300;

        // ---------- –ë–õ–û–ö–ò ----------
        const BLOCKS = {
            0: { name: '–í–æ–∑–¥—É—Ö', color: 'transparent', solid: false, texture: '', miningPower: 0, drop: [] },
            1: { name: '–ó–µ–º–ª—è', color: '#8B5A2B', solid: true, texture: 'üü´', miningPower: 1, drop: [{id:1, count:1}] },
            2: { name: '–¢—Ä–∞–≤–∞', color: '#4CAF50', solid: true, texture: 'üåø', miningPower: 1, drop: [{id:2, count:1}] },
            3: { name: '–ö–∞–º–µ–Ω—å', color: '#808080', solid: true, texture: 'ü™®', miningPower: 2, drop: [{id:3, count:1}] },
            4: { name: '–î–µ—Ä–µ–≤–æ', color: '#8B4513', solid: true, texture: 'ü™µ', miningPower: 1, drop: [{id:4, count:1}] },
            5: { name: '–õ–∏—Å—Ç–≤–∞', color: '#2E7D32', solid: true, texture: 'üçÉ', miningPower: 0.5, drop: [{id:4, count:1}] }, // –¥—Ä–æ–ø–∞–µ—Ç –¥–µ—Ä–µ–≤–æ
            6: { name: '–ü–µ—Å–æ–∫', color: '#F4E542', solid: true, texture: '‚è≥', miningPower: 0.5, drop: [{id:6, count:1}], fall: true },
            7: { name: '–ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞', color: '#CD7F32', solid: true, texture: '‚õ∞Ô∏è', miningPower: 3, drop: [{id:21, count:1}] },
            8: { name: '–ì–ª–∏–Ω–∞', color: '#B87333', solid: true, texture: 'üè∫', miningPower: 1, drop: [{id:8, count:1}] },
            9: { name: '–ì—Ä–∞–≤–∏–π', color: '#696969', solid: true, texture: 'ü™®', miningPower: 1, drop: [{id:9, count:1}], fall: true },
            10: { name: '–ü–æ—Å–µ–≤—ã (—Ä–æ—Å—Ç)', color: '#7CB342', solid: false, texture: 'üå±', miningPower: 0.5, drop: [] },
            11: { name: '–ü—à–µ–Ω–∏—Ü–∞', color: '#F0E68C', solid: false, texture: 'üåæ', miningPower: 0.5, drop: [{id:13, count:1}] },
            19: { name: '–í–µ—Ä—Å—Ç–∞–∫', color: '#A0522D', solid: true, texture: 'ü™ë', miningPower: 2, drop: [{id:19, count:1}] },
            20: { name: '–ü–µ—á—å', color: '#696969', solid: true, texture: 'üî•', miningPower: 3, drop: [{id:20, count:1}] },
            22: { name: '–£–≥–æ–ª—å–Ω–∞—è —Ä—É–¥–∞', color: '#2C2C2C', solid: true, texture: '‚ö´', miningPower: 2, drop: [{id:22, count:1}] },
            27: { name: '–î–≤–µ—Ä—å', color: '#8B4513', solid: true, texture: 'üö™', miningPower: 2, drop: [{id:27, count:1}] },
            28: { name: '–î–≤–µ—Ä—å (–æ—Ç–∫—Ä—ã—Ç–∞—è)', color: '#8B4513', solid: false, texture: 'üö™', miningPower: 2, drop: [{id:27, count:1}] },
            29: { name: '–°—É–Ω–¥—É–∫', color: '#D2B48C', solid: true, texture: 'üì¶', miningPower: 2, drop: [{id:29, count:1}] },
            30: { name: '–í–æ–¥–∞', color: '#1E90FF', solid: false, texture: 'üíß', miningPower: 0, drop: [] },
            31: { name: '–ü–µ—Å–æ–∫ –ø—É—Å—Ç—ã–Ω–∏', color: '#EDC9AF', solid: true, texture: '‚è≥', miningPower: 0.5, drop: [{id:31, count:1}], fall: true },
            32: { name: '–ö–∞–∫—Ç—É—Å', color: '#2E8B57', solid: true, texture: 'üåµ', miningPower: 1, drop: [{id:32, count:1}], damage: 10 },
            33: { name: '–õ–∏–∞–Ω–∞', color: '#228B22', solid: true, texture: 'üåø', miningPower: 0.5, drop: [] },
            34: { name: '–§–∞–∫–µ–ª', color: '#FFA500', solid: false, texture: 'üïØÔ∏è', miningPower: 0, drop: [{id:34, count:1}] },
            35: { name: '–ú–µ–¥–Ω–∞—è —Ä—É–¥–∞', color: '#B87333', solid: true, texture: 'üî∂', miningPower: 2, drop: [{id:35, count:1}] },
            36: { name: '–¢—Ä–∞–≤–∞ –¥–∂—É–Ω–≥–ª–µ–π', color: '#228B22', solid: true, texture: 'üåø', miningPower: 1, drop: [{id:36, count:1}] },
        };

        // ---------- –ü–†–ï–î–ú–ï–¢–´ (–î–û–ë–ê–í–õ–ï–ù–ê –†–´–ë–ê) ----------
        const ITEMS = {
            ...BLOCKS,
            12: { name: '–°–µ–º–µ–Ω–∞ –ø—à–µ–Ω–∏—Ü—ã', color: '#8B4513', texture: 'üå±', type: 'seed', cropBlock: 10, harvestBlock: 11, harvestItem: 13 },
            13: { name: '–ü—à–µ–Ω–∏—Ü–∞', color: '#F0E68C', texture: 'üåæ', type: 'food', foodValue: 20 },
            14: { name: '–ú—è—Å–æ', color: '#B22222', texture: 'üçñ', type: 'food', foodValue: 40 },
            15: { name: '–ö–∞–º–µ–Ω–Ω—ã–π –º–µ—á', color: '#CCC', texture: 'üó°Ô∏è', type: 'tool', damage: 20 },
            18: { name: '–•–ª–µ–±', color: '#D2691E', texture: 'üçû', type: 'food', foodValue: 30 },
            21: { name: '–ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞', color: '#CD7F32', texture: '‚õ∞Ô∏è', type: 'ore' },
            22: { name: '–£–≥–æ–ª—å', color: '#2C2C2C', texture: '‚ö´', type: 'fuel' },
            23: { name: '–ñ–µ–ª–µ–∑–Ω—ã–π —Å–ª–∏—Ç–æ–∫', color: '#A0A0A0', texture: 'üî©', type: 'material' },
            25: { name: '–ñ–µ–ª–µ–∑–Ω—ã–π –º–µ—á', color: '#A0A0A0', texture: '‚öîÔ∏è', type: 'tool', damage: 35 },
            26: { name: '–ñ–µ–ª–µ–∑–Ω–∞—è –∫–∏—Ä–∫–∞', color: '#A0A0A0', texture: '‚õèÔ∏è', type: 'tool', damage: 15, miningPower: 3, toolType: 'pickaxe' },
            27: { name: '–î–≤–µ—Ä—å', color: '#8B4513', texture: 'üö™', type: 'block' },
            29: { name: '–°—É–Ω–¥—É–∫', color: '#D2B48C', texture: 'üì¶', type: 'block' },
            30: { name: '–î–µ—Ä–µ–≤—è–Ω–Ω–∞—è –∫–∏—Ä–∫–∞', color: '#8B4513', texture: 'ü™ì', type: 'tool', damage: 10, miningPower: 2, toolType: 'pickaxe' },
            31: { name: '–ö–∞–º–µ–Ω–Ω–∞—è –∫–∏—Ä–∫–∞', texture: '‚õèÔ∏è', type: 'tool', damage: 12, miningPower: 3, toolType: 'pickaxe' },
            32: { name: '–ö–∞–∫—Ç—É—Å', texture: 'üåµ', type: 'block' },
            34: { name: '–§–∞–∫–µ–ª', texture: 'üïØÔ∏è', type: 'block', light: true },
            35: { name: '–ú–µ–¥–Ω–∞—è —Ä—É–¥–∞', texture: 'üî∂', type: 'ore' },
            36: { name: '–¢—Ä–∞–≤–∞ –¥–∂—É–Ω–≥–ª–µ–π', texture: 'üåø', type: 'block' },
            37: { name: '–ú–µ–¥–Ω—ã–π —Å–ª–∏—Ç–æ–∫', texture: 'üî∑', type: 'material' },
            38: { name: '–ú–µ–¥–Ω–∞—è –∫–∏—Ä–∫–∞', texture: '‚õèÔ∏è', type: 'tool', damage: 13, miningPower: 2, toolType: 'pickaxe' },
            39: { name: '–ú–µ–¥–Ω—ã–π –º–µ—á', texture: '‚öîÔ∏è', type: 'tool', damage: 22 },
            40: { name: '–ö–∞–º–µ–Ω–Ω—ã–π —Ç–æ–ø–æ—Ä', texture: 'ü™ì', type: 'tool', damage: 11, toolType: 'axe' },
            41: { name: '–ñ–µ–ª–µ–∑–Ω—ã–π —Ç–æ–ø–æ—Ä', texture: 'ü™ì', type: 'tool', damage: 18, toolType: 'axe' },
            42: { name: '–ë—É–º–µ—Ä–∞–Ω–≥', texture: 'ü™É', type: 'tool', damage: 25, ranged: true, boomerang: true },
            43: { name: '–õ—É–∫', texture: 'üèπ', type: 'tool', damage: 15, ranged: true, ammo: 44 },
            44: { name: '–°—Ç—Ä–µ–ª–∞', texture: 'üèπ', type: 'ammo' },
            45: { name: '–ö—Ä—é–∫-–∫–æ—à–∫–∞', texture: 'ü™ù', type: 'tool', hook: true },
            46: { name: '–ú–µ–¥–Ω—ã–π —à–ª–µ–º', texture: 'ü™ñ', type: 'armor', armor: 2, slot: 'helmet' },
            47: { name: '–ú–µ–¥–Ω—ã–π –Ω–∞–≥—Ä—É–¥–Ω–∏–∫', texture: 'üëï', type: 'armor', armor: 3, slot: 'chest' },
            48: { name: '–ú–µ–¥–Ω—ã–µ –ø–æ–Ω–æ–∂–∏', texture: 'üëñ', type: 'armor', armor: 2, slot: 'leggings' },
            49: { name: '–ñ–µ–ª–µ–∑–Ω—ã–π —à–ª–µ–º', texture: 'ü™ñ', type: 'armor', armor: 3, slot: 'helmet' },
            50: { name: '–ñ–µ–ª–µ–∑–Ω—ã–π –Ω–∞–≥—Ä—É–¥–Ω–∏–∫', texture: 'üëï', type: 'armor', armor: 4, slot: 'chest' },
            51: { name: '–ñ–µ–ª–µ–∑–Ω—ã–µ –ø–æ–Ω–æ–∂–∏', texture: 'üëñ', type: 'armor', armor: 3, slot: 'leggings' },
            52: { name: '–ú–æ–Ω–µ—Ç–∞', texture: 'ü™ô', type: 'currency' },
            // –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ä—ã–±–∞
            53: { name: '–†—ã–±–∞', texture: 'üêü', type: 'food', foodValue: 20 },
        };

        // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
        let inventory = [
            { id: 3, count: 10 },
            { id: 4, count: 5 },
            { id: 13, count: 3 },
            { id: 12, count: 2 },
        ];
        let selectedSlot = 0;
        let coins = 0;

        // –ú–∏—Ä
        let world = [];

        // –ò–≥—Ä–æ–∫
        let player = {
            x: 50 * BLOCK_SIZE,
            y: 30 * BLOCK_SIZE,
            vx: 0, vy: 0,
            width: 28, height: 42,
            onGround: false,
            speed: 5,
            jumpPower: 12,
            direction: 1,
            health: 100,
            maxHealth: 100,
            hunger: 100,
            maxHunger: 100,
            armor: { helmet: null, chest: null, leggings: null },
            hook: { active: false, x: 0, y: 0, target: null },
        };

        // –ñ–∏–≤–æ—Ç–Ω—ã–µ –∏ –º–æ–Ω—Å—Ç—Ä—ã
        let animals = [];
        let monsters = [];

        // –ö–∞–º–µ—Ä–∞
        let camera = { x: 0, y: 0 };

        // –í–≤–æ–¥
        let keys = {};
        let mouseX = 0, mouseY = 0, mouseWorldX = 0, mouseWorldY = 0, mouseBlockX = 0, mouseBlockY = 0;
        let mouseDown = { left: false, right: false };

        // –í—Ä–µ–º—è
        let timeOfDay = 0.3;
        let dayCount = 1;
        let lastTimeUpdate = performance.now();

        // –ú–µ–Ω—é
        let craftMenuOpen = false;
        let advCraftMenuOpen = false;
        let furnaceMenuOpen = false;

        // –°–º–µ—Ä—Ç—å
        let dead = false;
        let deathTimer = 0;

        // –ü–µ—á–∏ –∏ —Å—É–Ω–¥—É–∫–∏
        let furnaces = {};
        let chests = {};

        // ---------- –ì–ï–ù–ï–†–ê–¶–ò–Ø –ú–ò–†–ê ----------
        function generateWorld() {
            for (let y = 0; y < WORLD_HEIGHT; y++) {
                world[y] = [];
                for (let x = 0; x < WORLD_WIDTH; x++) {
                    let surfaceHeight = 30 + Math.sin(x * 0.05) * 5 + Math.cos(x * 0.03) * 3;
                    let biome = 'plains';
                    if (x > 120 && x < 160) biome = 'desert';
                    if (x > 40 && x < 80) biome = 'jungle';

                    if (y < surfaceHeight - 2) {
                        world[y][x] = 0;
                    } else if (y < surfaceHeight) {
                        if (biome === 'desert') world[y][x] = 31;
                        else if (biome === 'jungle') world[y][x] = 36;
                        else world[y][x] = 2;
                    } else if (y < surfaceHeight + 5) {
                        if (biome === 'desert') world[y][x] = 31;
                        else if (biome === 'jungle') world[y][x] = 1;
                        else world[y][x] = 1;
                    } else if (y < surfaceHeight + 15) {
                        if (Math.random() < 0.2) world[y][x] = 8;
                        else if (Math.random() < 0.15) world[y][x] = 9;
                        else world[y][x] = 3;
                    } else {
                        let r = Math.random();
                        if (r < 0.02 && y > surfaceHeight + 30) world[y][x] = 7;
                        else if (r < 0.04) world[y][x] = 22;
                        else if (r < 0.06) world[y][x] = 35;
                        else world[y][x] = 3;
                    }
                }
            }
            // –î–µ—Ä–µ–≤—å—è
            for (let x = 5; x < WORLD_WIDTH-5; x++) {
                if (Math.random() < 0.1) {
                    for (let y = 20; y < 40; y++) {
                        if (world[y][x] === 2 && world[y-1][x] === 0) {
                            for (let h = 1; h <= 4; h++) if (y-h >=0) world[y-h][x] = 4;
                            if (y-5 >=0) {
                                world[y-5][x] = 5;
                                if (x+1 < WORLD_WIDTH) world[y-5][x+1] = 5;
                                if (x-1 >=0) world[y-5][x-1] = 5;
                            }
                            break;
                        }
                    }
                }
            }
            // –ö–∞–∫—Ç—É—Å—ã
            for (let x = 5; x < WORLD_WIDTH-5; x++) {
                if (world[30][x] === 31 && Math.random() < 0.05) {
                    world[29][x] = 32;
                    world[28][x] = 32;
                    world[27][x] = 32;
                }
            }
            // –õ–∏–∞–Ω—ã
            for (let x = 5; x < WORLD_WIDTH-5; x++) {
                if (world[30][x] === 36 && Math.random() < 0.1) {
                    world[29][x] = 33;
                    world[28][x] = 33;
                }
            }
            // –û–∑—ë—Ä–∞
            for (let i = 0; i < 5; i++) {
                let lakeX = Math.floor(Math.random() * (WORLD_WIDTH - 20)) + 10;
                let lakeY = 30 + Math.floor(Math.random() * 5);
                for (let dy = 0; dy < 3; dy++) {
                    for (let dx = -2; dx <= 2; dx++) {
                        let x = lakeX + dx;
                        let y = lakeY + dy;
                        if (x >= 0 && x < WORLD_WIDTH && y >= 0 && y < WORLD_HEIGHT) {
                            if (world[y][x] === 2 || world[y][x] === 1 || world[y][x] === 31) {
                                world[y][x] = 30;
                            }
                        }
                    }
                }
            }
            // –°—É–Ω–¥—É–∫–∏ —Å —Å–æ–∫—Ä–æ–≤–∏—â–∞–º–∏
            for (let i = 0; i < 10; i++) {
                let x = Math.floor(Math.random() * (WORLD_WIDTH - 2)) + 1;
                let y = Math.floor(Math.random() * 40) + 20;
                if (world[y][x] === 0 && (world[y+1][x] === 1 || world[y+1][x] === 2 || world[y+1][x] === 3)) {
                    world[y][x] = 29;
                    let key = x + '_' + y;
                    chests[key] = [
                        { id: 52, count: Math.floor(Math.random()*10)+5 },
                        { id: 35, count: Math.floor(Math.random()*5)+1 },
                    ];
                }
            }
        }
        generateWorld();

        // ---------- –ò–ù–í–ï–ù–¢–ê–†–¨ ----------
        function updateInventoryUI() {
            const hotbar = document.getElementById('hotbar');
            hotbar.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const item = inventory[i];
                const slot = document.createElement('div');
                slot.className = `slot ${selectedSlot === i ? 'selected' : ''}`;
                if (item) {
                    const itm = ITEMS[item.id] || { name: '?', texture: '‚ùì' };
                    slot.innerHTML = `
                        <div class="slot-icon">${itm.texture}</div>
                        <div class="slot-count">${item.count}</div>
                        <div style="font-size:10px;">${itm.name}</div>
                    `;
                } else {
                    slot.innerHTML = `<div style="opacity:0.3">‚¨ú</div>`;
                }
                slot.onclick = () => selectSlot(i);
                hotbar.appendChild(slot);
            }
            document.getElementById('coin-counter').innerHTML = `ü™ô ${coins}`;
        }
        updateInventoryUI();

        function selectSlot(index) { selectedSlot = index; updateInventoryUI(); }

        function addItem(id, count) {
            if (id === 52) { coins += count; updateInventoryUI(); return; }
            for (let i = 0; i < inventory.length; i++) {
                if (inventory[i].id === id) {
                    inventory[i].count += count;
                    updateInventoryUI();
                    return;
                }
            }
            inventory.push({ id, count });
            updateInventoryUI();
        }

        function removeItem(id, count) {
            if (id === 52) {
                if (coins >= count) { coins -= count; updateInventoryUI(); return true; }
                return false;
            }
            for (let i = 0; i < inventory.length; i++) {
                if (inventory[i].id === id) {
                    inventory[i].count -= count;
                    if (inventory[i].count <= 0) inventory.splice(i, 1);
                    updateInventoryUI();
                    return true;
                }
            }
            return false;
        }

        function hasItems(requirements) {
            for (let req of requirements) {
                if (req.id === 52) { if (coins < req.count) return false; }
                else {
                    let found = false;
                    for (let item of inventory) {
                        if (item.id === req.id && item.count >= req.count) { found = true; break; }
                    }
                    if (!found) return false;
                }
            }
            return true;
        }

        function hasItem(id, count = 1) {
            if (id === 52) return coins >= count;
            for (let item of inventory) if (item.id === id && item.count >= count) return true;
            return false;
        }

        // ---------- –ö–†–ê–§–¢ ----------
        const recipes = [
            { id: 15, items: [{id:3, count:3}, {id:4, count:1}], resultCount: 1 },
            { id: 19, items: [{id:4, count:5}], resultCount: 1 },
            { id: 30, items: [{id:4, count:3}], resultCount: 1 },
            { id: 27, items: [{id:4, count:4}], resultCount: 1 },
            { id: 29, items: [{id:4, count:8}], resultCount: 1 },
            { id: 31, items: [{id:3, count:3}], resultCount: 1 },
            { id: 40, items: [{id:3, count:3}], resultCount: 1 },
            { id: 50, items: [{id:4, count:5}], resultCount: 1 }, // —É–¥–æ—á–∫–∞
            { id: 18, items: [{id:13, count:3}], resultCount: 1 },
            { id: 34, items: [{id:22, count:1}, {id:4, count:1}], resultCount: 3 },
            { id: 38, items: [{id:37, count:3}, {id:4, count:2}], resultCount: 1 },
            { id: 39, items: [{id:37, count:3}, {id:4, count:1}], resultCount: 1 },
            { id: 42, items: [{id:4, count:3}, {id:23, count:1}], resultCount: 1 },
            { id: 43, items: [{id:4, count:3}, {id:14, count:1}], resultCount: 1 },
            { id: 44, items: [{id:3, count:1}, {id:4, count:1}], resultCount: 5 },
            { id: 45, items: [{id:23, count:3}, {id:4, count:2}], resultCount: 1 },
        ];

        const advRecipes = [
            { id: 20, items: [{id:3, count:10}, {id:8, count:3}], resultCount: 1 },
            { id: 25, items: [{id:23, count:3}, {id:4, count:1}], resultCount: 1 },
            { id: 26, items: [{id:23, count:3}, {id:4, count:2}], resultCount: 1 },
            { id: 41, items: [{id:23, count:3}, {id:4, count:2}], resultCount: 1 },
            { id: 46, items: [{id:37, count:5}], resultCount: 1 },
            { id: 47, items: [{id:37, count:8}], resultCount: 1 },
            { id: 48, items: [{id:37, count:6}], resultCount: 1 },
            { id: 49, items: [{id:23, count:5}], resultCount: 1 },
            { id: 50, items: [{id:23, count:8}], resultCount: 1 },
            { id: 51, items: [{id:23, count:6}], resultCount: 1 },
        ];

        function craftItem(recipe) {
            if (!hasItems(recipe.items)) return false;
            for (let req of recipe.items) removeItem(req.id, req.count);
            addItem(recipe.id, recipe.resultCount || 1);
            return true;
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–æ–∫
        document.getElementById('craft-sword').onclick = () => craftItem(recipes[0]);
        document.getElementById('craft-workbench').onclick = () => craftItem(recipes[1]);
        document.getElementById('craft-woodpickaxe').onclick = () => craftItem(recipes[2]);
        document.getElementById('craft-door').onclick = () => craftItem(recipes[3]);
        document.getElementById('craft-chest').onclick = () => craftItem(recipes[4]);
        document.getElementById('craft-stonepickaxe').onclick = () => craftItem(recipes[5]);
        document.getElementById('craft-stoneaxe').onclick = () => craftItem(recipes[6]);
        document.getElementById('craft-fishingrod').onclick = () => craftItem(recipes[7]);
        document.getElementById('craft-bread').onclick = () => craftItem(recipes[8]);
        document.getElementById('craft-torch').onclick = () => craftItem(recipes[9]);
        document.getElementById('craft-copperpickaxe').onclick = () => craftItem(recipes[10]);
        document.getElementById('craft-coppersword').onclick = () => craftItem(recipes[11]);
        document.getElementById('craft-boomerang').onclick = () => craftItem(recipes[12]);
        document.getElementById('craft-bow').onclick = () => craftItem(recipes[13]);
        document.getElementById('craft-arrow').onclick = () => craftItem(recipes[14]);
        document.getElementById('craft-hook').onclick = () => craftItem(recipes[15]);

        document.getElementById('craft-furnace').onclick = () => craftItem(advRecipes[0]);
        document.getElementById('craft-iron-sword').onclick = () => craftItem(advRecipes[1]);
        document.getElementById('craft-iron-pickaxe').onclick = () => craftItem(advRecipes[2]);
        document.getElementById('craft-iron-axe').onclick = () => craftItem(advRecipes[3]);
        document.getElementById('craft-copper-helmet').onclick = () => craftItem(advRecipes[4]);
        document.getElementById('craft-copper-chest').onclick = () => craftItem(advRecipes[5]);
        document.getElementById('craft-copper-leggings').onclick = () => craftItem(advRecipes[6]);
        document.getElementById('craft-iron-helmet').onclick = () => craftItem(advRecipes[7]);
        document.getElementById('craft-iron-chest').onclick = () => craftItem(advRecipes[8]);
        document.getElementById('craft-iron-leggings').onclick = () => craftItem(advRecipes[9]);

        // –ü–ª–∞–≤–∫–∞
        document.getElementById('smelt-iron').onclick = () => {
            if (hasItems([{id:21, count:1}, {id:22, count:1}])) {
                removeItem(21,1); removeItem(22,1);
                addItem(23,1);
            }
        };
        document.getElementById('smelt-copper').onclick = () => {
            if (hasItems([{id:35, count:1}, {id:22, count:1}])) {
                removeItem(35,1); removeItem(22,1);
                addItem(37,1);
            }
        };

        // ---------- –í–†–ï–ú–Ø ----------
        function updateTime() {
            let now = performance.now();
            let delta = (now - lastTimeUpdate) / 60000;
            lastTimeUpdate = now;
            timeOfDay += delta * 1.0;
            if (timeOfDay >= 1) { timeOfDay = 0; dayCount++; }
            document.getElementById('clock').innerHTML = (timeOfDay < 0.5 ? '‚òÄÔ∏è' : 'üåô') + ' –î–µ–Ω—å ' + dayCount;
        }

        // ---------- –ì–û–õ–û–î ----------
        function updateHunger() {
            if (dead) return;
            player.hunger -= 0.002;
            if (player.hunger <= 0) {
                player.hunger = 0;
                player.health -= 0.005;
            }
            if (player.health > player.maxHealth) player.health = player.maxHealth;
            if (player.health < 0) player.health = 0;
            document.getElementById('health-fill').style.width = (player.health / player.maxHealth) * 100 + '%';
            document.getElementById('hunger-fill').style.width = (player.hunger / player.maxHunger) * 100 + '%';
        }

        // ---------- –°–ú–ï–†–¢–¨ ----------
        function checkDeath() {
            if (!dead && player.health <= 0) {
                dead = true;
                deathTimer = 120;
                document.getElementById('death-message').style.display = 'block';
            }
            if (dead) {
                deathTimer--;
                if (deathTimer <= 0) {
                    dead = false;
                    player.health = player.maxHealth;
                    player.hunger = player.maxHunger;
                    player.x = 50 * BLOCK_SIZE;
                    player.y = 30 * BLOCK_SIZE;
                    player.vx = 0; player.vy = 0;
                    document.getElementById('death-message').style.display = 'none';
                }
            }
        }

        // ---------- –ï–î–ê ----------
        function eatFood(itemId) {
            let foodItem = ITEMS[itemId];
            if (foodItem && foodItem.type === 'food') {
                if (removeItem(itemId, 1)) {
                    player.hunger = Math.min(player.hunger + foodItem.foodValue, player.maxHunger);
                }
            }
        }

        // ---------- –ú–û–ù–°–¢–†–´ ----------
        function spawnAnimal(x, y, type = 'cow') {
            animals.push({ x, y, vx:0, vy:0, width:30, height:30, onGround:false, type, health:20, readyToBreed:0 });
        }

        function spawnMonster(x, y, type) {
            let mob = { 
                x, y, vx:0, vy:0, width:28, height:40, onGround:false,
                type,
                health: type === 'slime' ? 20 : 50,
                damage: type === 'slime' ? 8 : 15,
                speed: type === 'slime' ? 0.8 : 1.2,
                jumpPower: type === 'slime' ? 6 : 8,
            };
            monsters.push(mob);
        }

        function canMoveMob(mob, newX, newY) {
            let left = Math.floor(newX / BLOCK_SIZE);
            let right = Math.floor((newX + mob.width) / BLOCK_SIZE);
            let top = Math.floor(newY / BLOCK_SIZE);
            let bottom = Math.floor((newY + mob.height) / BLOCK_SIZE);
            for (let yy = top; yy <= bottom; yy++) {
                for (let xx = left; xx <= right; xx++) {
                    if (xx >= 0 && xx < WORLD_WIDTH && yy >= 0 && yy < WORLD_HEIGHT) {
                        let block = world[yy][xx];
                        if (block !== 0 && BLOCKS[block].solid) return false;
                    }
                }
            }
            return true;
        }

        function updateMob(mob, targetX, targetY, isHostile) {
            if (dead) return;
            mob.vy += 0.5;
            if (mob.vy > 12) mob.vy = 12;

            let dx = targetX - mob.x;
            let dist = Math.abs(dx);
            if (dist > 10 && isHostile) {
                if (dx > 0) mob.vx = mob.speed;
                else mob.vx = -mob.speed;
            } else {
                mob.vx *= 0.8;
            }

            let futureX = mob.x + mob.vx;
            if (!canMoveMob(mob, futureX, mob.y) && mob.onGround) mob.vy = -mob.jumpPower;

            let newX = mob.x + mob.vx;
            if (canMoveMob(mob, newX, mob.y)) mob.x = newX;
            else mob.vx = 0;

            let newY = mob.y + mob.vy;
            mob.onGround = false;
            if (canMoveMob(mob, mob.x, newY)) mob.y = newY;
            else { if (mob.vy > 0) mob.onGround = true; mob.vy = 0; }

            mob.x = Math.max(0, Math.min(mob.x, WORLD_WIDTH * BLOCK_SIZE - mob.width));
            mob.y = Math.max(0, Math.min(mob.y, WORLD_HEIGHT * BLOCK_SIZE - mob.height));

            if (isHostile && Math.hypot(mob.x - player.x, mob.y - player.y) < 40) {
                player.health -= mob.damage;
            }
        }

        // ---------- –§–ò–ó–ò–ö–ê –ò–ì–†–û–ö–ê ----------
        function canMovePlayer(x, y) {
            let left = Math.floor(x / BLOCK_SIZE);
            let right = Math.floor((x + player.width) / BLOCK_SIZE);
            let top = Math.floor(y / BLOCK_SIZE);
            let bottom = Math.floor((y + player.height) / BLOCK_SIZE);
            for (let yy = top; yy <= bottom; yy++) {
                for (let xx = left; xx <= right; xx++) {
                    if (xx >= 0 && xx < WORLD_WIDTH && yy >= 0 && yy < WORLD_HEIGHT) {
                        let block = world[yy][xx];
                        if (block !== 0 && BLOCKS[block].solid) return false;
                    }
                }
            }
            return true;
        }

        function updatePlayer() {
            if (dead) return;

            if (keys['a']||keys['arrowleft']) { player.vx = -player.speed; player.direction = -1; }
            else if (keys['d']||keys['arrowright']) { player.vx = player.speed; player.direction = 1; }
            else player.vx *= 0.8;

            if ((keys[' ']||keys['w']||keys['arrowup']) && player.onGround) { player.vy = -player.jumpPower; player.onGround = false; }

            player.vy += 0.5;
            if (player.vy > 15) player.vy = 15;

            let nx = player.x + player.vx;
            if (canMovePlayer(nx, player.y)) player.x = nx;

            let ny = player.y + player.vy;
            player.onGround = false;
            if (canMovePlayer(player.x, ny)) player.y = ny;
            else { if (player.vy > 0) player.onGround = true; player.vy = 0; }

            camera.x = player.x - canvas.width/2;
            camera.y = player.y - canvas.height/2;
            camera.x = Math.max(0, Math.min(camera.x, WORLD_WIDTH*BLOCK_SIZE - canvas.width));
            camera.y = Math.max(0, Math.min(camera.y, WORLD_HEIGHT*BLOCK_SIZE - canvas.height));
        }

        // ---------- –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï (–ò–°–ü–†–ê–í–õ–ï–ù–ê –†–´–ë–ê–õ–ö–ê) ----------
        function handleInput() {
            if (dead) return;

            if (mouseDown.left) {
                let attacked = false;
                for (let i = monsters.length-1; i>=0; i--) {
                    let m = monsters[i];
                    let dx = mouseWorldX - m.x;
                    let dy = mouseWorldY - m.y;
                    if (Math.abs(dx) < 40 && Math.abs(dy) < 40) {
                        let dmg = 10;
                        let item = inventory[selectedSlot];
                        if (item && ITEMS[item.id] && ITEMS[item.id].type === 'tool') dmg = ITEMS[item.id].damage;
                        m.health -= dmg;
                        if (m.health <= 0) {
                            monsters.splice(i,1);
                            addItem(14, 1); // –º—è—Å–æ
                        }
                        attacked = true;
                        break;
                    }
                }
                if (!attacked && mouseBlockX>=0 && mouseBlockX<WORLD_WIDTH && mouseBlockY>=0 && mouseBlockY<WORLD_HEIGHT) {
                    let block = world[mouseBlockY][mouseBlockX];
                    if (block !== 0) {
                        // –°–º–µ—Ä—Ç—å –±–µ–∑ –∫–∏—Ä–∫–∏ –¥–ª—è –∫–∞–º–Ω—è/—Ä—É–¥—ã
                        let hardBlocks = [3,7,22,35];
                        if (hardBlocks.includes(block)) {
                            let sel = inventory[selectedSlot];
                            let hasPickaxe = sel && ITEMS[sel.id] && ITEMS[sel.id].toolType === 'pickaxe';
                            if (!hasPickaxe) {
                                player.health = 0;
                                mouseDown.left = false;
                                return;
                            }
                        }
                        // –°—É–Ω–¥—É–∫
                        if (block === 29) {
                            let key = mouseBlockX + '_' + mouseBlockY;
                            if (chests[key]) {
                                for (let it of chests[key]) addItem(it.id, it.count);
                                delete chests[key];
                            }
                        }
                        // –°–±–æ—Ä —É—Ä–æ–∂–∞—è
                        if (block === 11) {
                            addItem(13, 1);
                            if (Math.random() < 0.2) addItem(12, 1);
                            world[mouseBlockY][mouseBlockX] = 0;
                        } else if (block !== 30) { // –≤–æ–¥—É –Ω–µ –ª–æ–º–∞–µ–º
                            if (block === 2 && Math.random() < 0.2) addItem(12, 1);
                            let drops = BLOCKS[block].drop;
                            for (let d of drops) addItem(d.id, d.count);
                            world[mouseBlockY][mouseBlockX] = 0;
                        }
                    }
                }
                mouseDown.left = false;
            }

            if (mouseDown.right) {
                let sel = inventory[selectedSlot];
                if (mouseBlockX>=0 && mouseBlockX<WORLD_WIDTH && mouseBlockY>=0 && mouseBlockY<WORLD_HEIGHT) {
                    let targetBlock = world[mouseBlockY][mouseBlockX];
                    // –î–≤–µ—Ä—å
                    if (targetBlock === 27 || targetBlock === 28) {
                        world[mouseBlockY][mouseBlockX] = targetBlock === 27 ? 28 : 27;
                        mouseDown.right = false;
                        return;
                    }
                    // –°—É–Ω–¥—É–∫
                    if (targetBlock === 29) {
                        let key = mouseBlockX + '_' + mouseBlockY;
                        if (!chests[key]) chests[key] = [];
                        if (!sel) {
                            if (chests[key].length > 0) {
                                let item = chests[key].shift();
                                addItem(item.id, item.count);
                            }
                        } else {
                            if (removeItem(sel.id, 1)) {
                                let found = chests[key].find(i => i.id === sel.id);
                                if (found) found.count++;
                                else chests[key].push({ id: sel.id, count: 1 });
                            }
                        }
                        mouseDown.right = false;
                        return;
                    }
                    // –í–µ—Ä—Å—Ç–∞–∫
                    if (targetBlock === 19) {
                        let dist = Math.hypot(mouseWorldX - player.x, mouseWorldY - player.y);
                        if (dist < 60) {
                            advCraftMenuOpen = !advCraftMenuOpen;
                            document.getElementById('adv-craft-menu').style.display = advCraftMenuOpen ? 'flex' : 'none';
                            if (advCraftMenuOpen) { craftMenuOpen = false; document.getElementById('craft-menu').style.display = 'none'; furnaceMenuOpen = false; document.getElementById('furnace-menu').style.display = 'none'; }
                        }
                        mouseDown.right = false;
                        return;
                    }
                    // –ü–µ—á—å
                    if (targetBlock === 20) {
                        furnaceMenuOpen = !furnaceMenuOpen;
                        document.getElementById('furnace-menu').style.display = furnaceMenuOpen ? 'flex' : 'none';
                        if (furnaceMenuOpen) { craftMenuOpen = false; document.getElementById('craft-menu').style.display = 'none'; advCraftMenuOpen = false; document.getElementById('adv-craft-menu').style.display = 'none'; }
                        mouseDown.right = false;
                        return;
                    }
                    // –†—ã–±–∞–ª–∫–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ä—ã–±–∞)
                    if (targetBlock === 30 && sel && ITEMS[sel.id] && ITEMS[sel.id].fishing) {
                        if (Math.random() < 0.3) {
                            addItem(53, 1); // ID —Ä—ã–±—ã 53
                            console.log('–í—ã –ø–æ–π–º–∞–ª–∏ —Ä—ã–±—É!');
                        } else {
                            console.log('–†—ã–±–∞ —Å–æ—Ä–≤–∞–ª–∞—Å—å...');
                        }
                        mouseDown.right = false;
                        return;
                    }
                }

                if (sel) {
                    let item = ITEMS[sel.id];
                    if (item.type === 'food') eatFood(sel.id);
                    else if (item.type === 'seed') {
                        if (mouseBlockY+1 < WORLD_HEIGHT && (world[mouseBlockY][mouseBlockX] === 1 || world[mouseBlockY][mouseBlockX] === 2)) {
                            if (removeItem(sel.id, 1)) {
                                world[mouseBlockY][mouseBlockX] = 10;
                                setTimeout(() => { if (world[mouseBlockY][mouseBlockX] === 10) world[mouseBlockY][mouseBlockX] = 11; }, 10000);
                            }
                        }
                    } else if (item.type === 'block' || (sel.id in BLOCKS && BLOCKS[sel.id].solid)) {
                        if (world[mouseBlockY][mouseBlockX] === 0) {
                            world[mouseBlockY][mouseBlockX] = sel.id;
                            removeItem(sel.id, 1);
                        }
                    }
                }
                mouseDown.right = false;
            }
        }

        // ---------- –°–ü–ê–í–ù –ú–û–ù–°–¢–†–û–í ----------
        function spawnMobs() {
            if (dead) return;
            if (timeOfDay > 0.6 && timeOfDay < 0.9 && monsters.length < 10) {
                if (Math.random() < 0.015) {
                    let angle = Math.random() * 2*Math.PI;
                    let dist = 500;
                    let x = player.x + Math.cos(angle) * dist;
                    let y = player.y + Math.sin(angle) * dist;
                    let by = Math.floor(y / BLOCK_SIZE);
                    for (let yy = by; yy < WORLD_HEIGHT; yy++) {
                        if (world[yy][Math.floor(x/BLOCK_SIZE)] !== 0) {
                            let type = Math.random() < 0.5 ? 'zombie' : 'slime';
                            spawnMonster(x, yy * BLOCK_SIZE - 40, type);
                            break;
                        }
                    }
                }
            }
        }

        // ---------- –û–ë–ù–û–í–õ–ï–ù–ò–ï –ú–û–ë–û–í ----------
        function updateAllMobs() {
            for (let a of animals) {
                updateMob(a, a.x + (Math.random()-0.5)*100, a.y, false);
            }
            for (let m of monsters) {
                updateMob(m, player.x, player.y, true);
            }
        }

        // ---------- –û–¢–†–ò–°–û–í–ö–ê ----------
        function draw() {
            let skyColor = timeOfDay < 0.5 ? '#87CEEB' : '#0a1a2a';
            ctx.fillStyle = skyColor;
            ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.save();
            ctx.translate(-camera.x, -camera.y);

            // –ë–ª–æ–∫–∏
            for (let y = Math.floor(camera.y/BLOCK_SIZE)-2; y < Math.floor((camera.y+canvas.height)/BLOCK_SIZE)+2; y++) {
                for (let x = Math.floor(camera.x/BLOCK_SIZE)-2; x < Math.floor((camera.x+canvas.width)/BLOCK_SIZE)+2; x++) {
                    if (x>=0 && x<WORLD_WIDTH && y>=0 && y<WORLD_HEIGHT) {
                        let b = world[y][x];
                        if (b !== 0) {
                            let block = BLOCKS[b] || {color:'#f0f', texture:'?'};
                            ctx.fillStyle = block.color;
                            ctx.shadowBlur = 5;
                            ctx.shadowColor = '#000';
                            ctx.fillRect(x*BLOCK_SIZE, y*BLOCK_SIZE, BLOCK_SIZE-1, BLOCK_SIZE-1);
                            ctx.font = '25px Arial';
                            ctx.fillStyle = '#fff';
                            ctx.fillText(block.texture, x*BLOCK_SIZE+7, y*BLOCK_SIZE+30);
                        }
                    }
                }
            }

            // –ñ–∏–≤–æ—Ç–Ω—ã–µ
            for (let a of animals) {
                ctx.fillStyle = '#8B4513';
                ctx.beginPath();
                ctx.ellipse(a.x + 15, a.y - 10, 15, 10, 0, 0, Math.PI*2);
                ctx.fill();
                ctx.fillStyle = '#FFF';
                ctx.font = '20px Arial';
                ctx.fillText('üêÆ', a.x, a.y-30);
            }

            // –ú–æ–Ω—Å—Ç—Ä—ã
            for (let m of monsters) {
                ctx.fillStyle = m.type === 'slime' ? '#0F0' : '#2a5';
                ctx.beginPath();
                if (m.type === 'slime') {
                    ctx.ellipse(m.x + 14, m.y - 5, 12, 10, 0, 0, Math.PI*2);
                } else {
                    ctx.ellipse(m.x + 14, m.y - 10, 14, 20, 0, 0, Math.PI*2);
                }
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.font = '20px Arial';
                ctx.fillText(m.type === 'slime' ? 'üëæ' : 'üßü', m.x, m.y-35);
            }

            // –ò–≥—Ä–æ–∫
            ctx.fillStyle = '#4ECDC4';
            ctx.fillRect(player.x, player.y, player.width, player.height);
            ctx.fillStyle = '#F0E68C';
            ctx.beginPath();
            ctx.arc(player.x + player.width/2, player.y - 5, 12, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(player.x + player.width/2 - 4, player.y - 9, 2, 0, 2*Math.PI);
            ctx.arc(player.x + player.width/2 + 4, player.y - 9, 2, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillStyle = '#4ECDC4';
            ctx.fillRect(player.x - 5, player.y + 5, 5, 15);
            ctx.fillRect(player.x + player.width, player.y + 5, 5, 15);
            ctx.fillRect(player.x + 3, player.y + player.height, 8, 10);
            ctx.fillRect(player.x + player.width - 11, player.y + player.height, 8, 10);

            // –û—Ä—É–∂–∏–µ
            let selItem = inventory[selectedSlot];
            if (selItem && ITEMS[selItem.id] && ITEMS[selItem.id].type === 'tool' && !ITEMS[selItem.id].fishing) {
                ctx.strokeStyle = '#A52A2A';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(player.x + player.width + 5, player.y + 10);
                ctx.lineTo(player.x + player.width + 20, player.y - 5);
                ctx.stroke();
            }

            ctx.restore();

            requestAnimationFrame(draw);
        }

        // ---------- –°–û–•–†–ê–ù–ï–ù–ò–ï/–ó–ê–ì–†–£–ó–ö–ê ----------
        function saveGame() {
            let save = {
                world, inventory, player: { x:player.x, y:player.y, health:player.health, hunger:player.hunger, dayCount, timeOfDay, armor:player.armor },
                animals, monsters, furnaces, chests, coins,
            };
            localStorage.setItem('terrariaSave', JSON.stringify(save));
            alert('–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        }

        function loadGame() {
            let save = JSON.parse(localStorage.getItem('terrariaSave'));
            if (save) {
                world = save.world; inventory = save.inventory;
                player.x = save.player.x; player.y = save.player.y;
                player.health = save.player.health; player.hunger = save.player.hunger;
                dayCount = save.dayCount; timeOfDay = save.timeOfDay;
                player.armor = save.player.armor || { helmet: null, chest: null, leggings: null };
                animals = save.animals || []; monsters = save.monsters || [];
                furnaces = save.furnaces || {}; chests = save.chests || {};
                coins = save.coins || 0;
                updateInventoryUI();
            }
        }

        document.getElementById('btn-save').onclick = saveGame;
        document.getElementById('btn-load').onclick = loadGame;

        // ---------- –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ ----------
        function gameLoop() {
            updateTime();
            updateHunger();
            checkDeath();
            if (!dead) {
                updatePlayer();
                handleInput();
                updateAllMobs();
                spawnMobs();
            }
            document.getElementById('debug').innerHTML = `–ú–æ–Ω—Å—Ç—Ä–æ–≤: ${monsters.length}`;
        }
        setInterval(gameLoop, 1000/60);
        draw();

        // –ù–∞—á–∞–ª—å–Ω—ã–µ –∂–∏–≤–æ—Ç–Ω—ã–µ
        for (let i=0; i<3; i++) spawnAnimal(60*BLOCK_SIZE + i*60, 25*BLOCK_SIZE, 'cow');

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é
        window.addEventListener('keydown', (e) => {
            let k = e.key.toLowerCase();
            keys[k] = true;
            if (k >= '1' && k <= '8') selectSlot(parseInt(k)-1);
            if (k === 'e') {
                craftMenuOpen = !craftMenuOpen;
                document.getElementById('craft-menu').style.display = craftMenuOpen ? 'flex' : 'none';
                if (craftMenuOpen) {
                    advCraftMenuOpen = false; document.getElementById('adv-craft-menu').style.display = 'none';
                    furnaceMenuOpen = false; document.getElementById('furnace-menu').style.display = 'none';
                }
            }
            if (k === 'f') {
                furnaceMenuOpen = !furnaceMenuOpen;
                document.getElementById('furnace-menu').style.display = furnaceMenuOpen ? 'flex' : 'none';
                if (furnaceMenuOpen) {
                    craftMenuOpen = false; document.getElementById('craft-menu').style.display = 'none';
                    advCraftMenuOpen = false; document.getElementById('adv-craft-menu').style.display = 'none';
                }
            }
        });
        window.addEventListener('keyup', (e) => { keys[e.key.toLowerCase()] = false; });

        canvas.addEventListener('mousemove', (e) => {
            let rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            mouseWorldX = mouseX + camera.x;
            mouseWorldY = mouseY + camera.y;
            mouseBlockX = Math.floor(mouseWorldX / BLOCK_SIZE);
            mouseBlockY = Math.floor(mouseWorldY / BLOCK_SIZE);
        });

        canvas.addEventListener('mousedown', (e) => { e.preventDefault(); if (e.button===0) mouseDown.left=true; if (e.button===2) mouseDown.right=true; });
        canvas.addEventListener('mouseup', (e) => { if (e.button===0) mouseDown.left=false; if (e.button===2) mouseDown.right=false; });
        canvas.addEventListener('contextmenu', (e) => e.preventDefault());

        console.log('–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Ä—ã–±–∞–ª–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ä—ã–±–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å');
    </script>
</body>
</html>
